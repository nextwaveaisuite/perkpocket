<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PerkPocket Admin Console</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body { background:#0d1117;color:#e6edf3;font-family:Inter,system-ui,Arial,sans-serif;margin:0; }
    .wrap { max-width:1100px;margin:40px auto;padding:0 16px; }
    .card { background:#161b22;border:1px solid #30363d;border-radius:12px;box-shadow:0 0 20px rgba(0,0,0,.25);padding:16px; }
    .row { display:flex; gap:16px; align-items: stretch; }
    .col { flex:1; }
    h1,h2,h3{margin:0 0 12px}
    .topbar { display:flex;justify-content:space-between;align-items:center;margin-bottom:16px }
    .pill { background:#21262d;border:1px solid #30363d;color:#e6edf3;padding:8px 12px;border-radius:999px; }
    .btn { background:#238636;border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600 }
    .btn.secondary { background:#21262d }
    .btn.danger { background:#d0342c }
    .btn:disabled{opacity:.6;cursor:not-allowed}
    select, input[type="text"], input[type="password"] { width:100%;padding:10px;border-radius:8px;border:1px solid #30363d;background:#0d1117;color:#e6edf3 }
    table { width:100%;border-collapse:collapse;margin-top:10px }
    th,td { border:1px solid #30363d;padding:8px;text-align:left;vertical-align:top }
    th { background:#21262d }
    a { color:#58a6ff; }
    .center { min-height:100vh;display:grid;place-items:center }
    .login { width:340px }
    .field { margin:10px 0 }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // =========================
    //  SIMPLE PASSWORD LOGIN
    // =========================
    const ADMIN_PASSWORD = "1Church@Miles_St_MountIsa"; // pre-filled per your request

    const state = {
      data: null,          // offers.json content
      market: "AU",        // current market selection
      category: null,      // current category selection
      dirty: false,        // tracks unsaved edits
      networks: {}         // networks.json mapping
    };

    const EL = id => document.getElementById(id);

    (async function init() {
      if (sessionStorage.getItem("perkAdminAuth") === "granted") {
        await initApp();
      } else {
        renderLogin();
      }
    })();

    function renderLogin() {
      document.getElementById("app").innerHTML = `
        <div class="center">
          <div class="card login">
            <h2>PerkPocket Admin Login</h2>
            <div class="field"><input id="pw" type="password" placeholder="Enter Admin Password" /></div>
            <button class="btn" onclick="checkLogin()">Login</button>
          </div>
        </div>
      `;
    }

    function checkLogin() {
      const input = document.getElementById("pw").value.trim();
      if (input === ADMIN_PASSWORD) {
        sessionStorage.setItem("perkAdminAuth", "granted");
        initApp();
      } else {
        alert("Incorrect password ❌");
      }
    }

    // =========================
    //       MAIN ADMIN UI
    // =========================
    async function initApp() {
      document.getElementById("app").innerHTML = `<div class="wrap" id="root"></div>`;
      await loadData();
      renderAdmin();
    }

    async function loadData() {
      try {
        const [netRes, offRes] = await Promise.all([
          fetch("/networks.json", { cache: "no-cache" }),
          fetch("/offers.json",   { cache: "no-cache" })
        ]);
        state.networks = await netRes.json();
        state.data = await offRes.json();
        const cats = Object.keys(state.data[state.market] || {});
        state.category = cats[0] || null;
      } catch (e) {
        console.error(e);
        state.networks = {};
        state.data = { AU: {}, UK: {} };
        state.category = null;
      }
    }

    function renderAdmin() {
      const root = document.getElementById("root");
      const markets = Object.keys(state.data || {});
      const categories = state.data[state.market] ? Object.keys(state.data[state.market]) : [];

      root.innerHTML = `
        <div class="topbar">
          <h1>PerkPocket Admin Console</h1>
          <div>
            <span class="pill">${state.dirty ? "Unsaved changes" : "All changes saved"}</span>
            <input type="file" id="importFile" accept="application/json" style="display:none" onchange="importJSON(event)">
            <button class="btn secondary" onclick="document.getElementById('importFile').click()">Import JSON</button>
            <button class="btn secondary" onclick="exportJSON()">Export JSON</button>
            <button class="btn danger" onclick="logout()">Logout</button>
          </div>
        </div>

        <div class="row">
          <div class="col card">
            <h3>Market</h3>
            <select onchange="onMarketChange(this.value)">
              ${markets.map(m => `<option value="${m}" ${m===state.market?"selected":""}>${m}</option>`).join("")}
            </select>

            <h3 style="margin-top:16px;">Category</h3>
            <select onchange="onCategoryChange(this.value)">
              ${categories.length ? categories.map(c => `<option value="${c}" ${c===state.category?"selected":""}>${c}</option>`).join("") : `<option>(none)</option>`}
            </select>

            <div style="margin-top:16px">
              <button class="btn" onclick="addCategory()">+ Add Category</button>
              <button class="btn secondary" onclick="renameCategory()">Rename</button>
              <button class="btn danger" onclick="deleteCategory()">Delete</button>
            </div>
          </div>

          <div class="col card" style="flex:2">
            <h3>Offers — ${state.market}${state.category ? " • " + state.category : ""}</h3>
            ${renderOffersTable()}
            <div style="margin-top:10px">
              <button class="btn" onclick="addOffer()">+ Add Offer</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderOffersTable() {
      const list = (state.data[state.market] && state.data[state.market][state.category]) || [];
      if (!state.category) return `<p>No category selected. Create or select one on the left.</p>`;
      if (!list.length) return `<p>No offers yet in <b>${state.category}</b>. Click “+ Add Offer”.</p>`;

      return `
        <table>
          <tr><th>Offer Name</th><th>Base Affiliate URL</th><th>Network</th><th>Payout</th><th>Status</th><th>Actions</th></tr>
          ${list.map((o, i) => `
            <tr>
              <td><input type="text" value="${escapeHtml(o.name)}" oninput="editOffer(${i}, 'name', this.value)" /></td>
              <td><input type="text" value="${escapeHtml(o.baseUrl || o.url || '')}" placeholder="Paste your full affiliate link" oninput="editOffer(${i}, 'baseUrl', this.value)" /></td>
              <td>
                <select onchange="editOffer(${i}, 'network', this.value)">
                  ${Object.entries(state.networks).map(([k,v]) => `
                    <option value="${k}" ${o.network===k ? 'selected' : ''}>${v.name || k}</option>
                  `).join('')}
                </select>
              </td>
              <td><input type="text" value="${escapeHtml(o.payout||'')}" oninput="editOffer(${i}, 'payout', this.value)" /></td>
              <td>
                <select onchange="editOffer(${i}, 'status', this.value)">
                  ${["Active","Pending","Paused"].map(s => `<option ${o.status===s?"selected":""}>${s}</option>`).join("")}
                </select>
              </td>
              <td>
                <button class="btn secondary" onclick="previewOffer(${i})">Preview</button>
                <button class="btn danger" onclick="removeOffer(${i})">Delete</button>
              </td>
            </tr>
          `).join("")}
        </table>
      `;
    }

    // ======= Actions =======
    function onMarketChange(m) {
      state.market = m;
      const cats = Object.keys(state.data[state.market] || {});
      state.category = cats[0] || null;
      renderAdmin();
    }

    function onCategoryChange(c) {
      state.category = c;
      renderAdmin();
    }

    function addCategory() {
      const name = prompt("New category name:");
      if (!name) return;
      if (!state.data[state.market]) state.data[state.market] = {};
      if (!state.data[state.market][name]) state.data[state.market][name] = [];
      state.dirty = true;
      state.category = name;
      renderAdmin();
    }

    function renameCategory() {
      if (!state.category) return alert("No category selected.");
      const next = prompt("Rename category:", state.category);
      if (!next || next === state.category) return;
      const list = state.data[state.market][state.category];
      delete state.data[state.market][state.category];
      state.data[state.market][next] = list;
      state.category = next;
      state.dirty = true;
      renderAdmin();
    }

    function deleteCategory() {
      if (!state.category) return alert("No category selected.");
      if (!confirm(`Delete category "${state.category}" and all its offers?`)) return;
      delete state.data[state.market][state.category];
      const cats = Object.keys(state.data[state.market] || {});
      state.category = cats[0] || null;
      state.dirty = true;
      renderAdmin();
    }

    function addOffer() {
      if (!state.category) return alert("Create or select a category first.");
      const name = prompt("Offer name:");
      const baseUrl = prompt("Offer URL (your affiliate link):");
      const network = prompt("Network key (e.g., awin, cj, impact):", "awin") || "awin";
      if (!name || !baseUrl) return;
      state.data[state.market][state.category].push({ name, baseUrl, network, payout: "", status: "Active" });
      state.dirty = true;
      renderAdmin();
    }

    function editOffer(i, field, value) {
      state.data[state.market][state.category][i][field] = value;
      state.dirty = true;
    }

    function removeOffer(i) {
      if (!confirm("Delete this offer?")) return;
      state.data[state.market][state.category].splice(i, 1);
      state.dirty = true;
      renderAdmin();
    }

    function previewOffer(i) {
      const o = state.data[state.market][state.category][i];
      const userRef = 'admin_preview';
      const param = (state.networks[o.network]?.param) || 'ref';
      const glue = (o.baseUrl || '').includes('?') ? '&' : '?';
      const url = `${o.baseUrl}${glue}${encodeURIComponent(param)}=${encodeURIComponent(userRef)}`;
      if (o.baseUrl) window.open(url, '_blank');
    }

    function exportJSON() {
      const blob = new Blob([JSON.stringify(state.data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "offers.json";
      a.click();
      URL.revokeObjectURL(a.href);
      state.dirty = false;
      renderAdmin();
      alert("Downloaded updated offers.json. Upload this file to /public/offers.json in GitHub to apply changes.");
    }

    function importJSON(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!data || typeof data !== 'object') throw new Error('Invalid JSON');
          state.data = data;
          state.market = Object.keys(state.data)[0] || 'AU';
          state.category = Object.keys(state.data[state.market] || {})[0] || null;
          state.dirty = true;
          renderAdmin();
          alert('Imported! Click “Export JSON” to download your updated master file, then upload to /public/offers.json.');
        } catch (err) {
          alert('Import failed: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    function logout() {
      sessionStorage.removeItem("perkAdminAuth");
      location.href = "/";
    }

    // helpers
    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, r => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[r]));
    }
  </script>
</body>
</html>
